{% extends "base.html" %}

{% block title %}Expense Settings - CRM System{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('settings.index') }}">Settings</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('settings.dropdowns') }}">Dropdowns</a></li>
<li class="breadcrumb-item active">Expense Settings</li>
{% endblock %}

{% block content %}
<style>
.sub-category-section {
    display: none;
}
.sub-category-section.expanded {
    display: block;
}
</style>
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-cash-coin"></i> Expense Settings
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Manage expense categories and their sub-categories.</p>

                <!-- Main Categories Section -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-primary mb-0">Main Categories</h6>
                        <button class="btn btn-sm btn-outline-success" id="addMainCategoryBtn">
                            <i class="bi bi-plus"></i> Add Main Category
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                    <th>Sub Categories</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="mainCategoriesTable">
                                {% for category in main_categories %}
                                <tr data-id="{{ category.id }}" data-key="{{ category.key }}">
                                    <td>{{ category.key }}</td>
                                    <td>
                                        <span class="category-value">{{ category.value }}</span>
                                        <input type="text" class="form-control form-control-sm d-none edit-input" value="{{ category.value }}">
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ sub_categories_by_main.get(category.key, [])|length }}</span>
                                        <button class="btn btn-sm btn-outline-info ms-2 view-sub-btn" data-category="{{ category.key }}">
                                            <i class="bi bi-eye"></i> View
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary edit-category-btn" data-id="{{ category.id }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-category-btn" data-id="{{ category.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sub Categories Section -->
                {% for category in main_categories %}
                <div class="mb-4 sub-category-section {% if sub_categories_by_main.get(category.key) %}expanded{% endif %}" id="sub-category-{{ category.key }}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-primary mb-0">
                            <i class="bi bi-arrow-return-right"></i> {{ category.value }} - Sub Categories
                        </h6>
                        <button class="btn btn-sm btn-outline-success add-sub-btn" data-category="{{ category.key }}">
                            <i class="bi bi-plus"></i> Add Sub Category
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="subCategoriesTable-{{ category.key }}">
                                {% for sub_cat in sub_categories_by_main.get(category.key, []) %}
                                <tr data-id="{{ sub_cat.id }}">
                                    <td>{{ sub_cat.key }}</td>
                                    <td>
                                        <span class="setting-value">{{ sub_cat.value }}</span>
                                        <input type="text" class="form-control form-control-sm d-none edit-input" value="{{ sub_cat.value }}">
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary edit-btn" data-id="{{ sub_cat.id }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-btn" data-id="{{ sub_cat.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Add Main Category Modal -->
<div class="modal fade" id="addMainCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Main Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMainCategoryForm">
                    <div class="mb-3">
                        <label class="form-label">Key</label>
                        <input type="text" class="form-control" id="newMainKey" required>
                        <small class="form-text text-muted">Use lowercase with underscores (e.g., company_expense)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Value</label>
                        <input type="text" class="form-control" id="newMainValue" required>
                        <small class="form-text text-muted">Display name (e.g., Company Expense)</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMainCategoryBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Sub Category Modal -->
<div class="modal fade" id="addSubCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Sub Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addSubCategoryForm">
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-control" id="subCategoryParent" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Key</label>
                        <input type="text" class="form-control" id="newSubKey" required>
                        <small class="form-text text-muted">Will be prefixed with category (e.g., company_expense_rent)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Value</label>
                        <input type="text" class="form-control" id="newSubValue" required>
                        <small class="form-text text-muted">Display name (e.g., Rent)</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSubCategoryBtn">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentCategory = '';
    let currentSettingId = null;

    // Add Main Category
    document.getElementById('addMainCategoryBtn').addEventListener('click', function() {
        document.getElementById('newMainKey').value = '';
        document.getElementById('newMainValue').value = '';
        new bootstrap.Modal(document.getElementById('addMainCategoryModal')).show();
    });

    document.getElementById('saveMainCategoryBtn').addEventListener('click', function() {
        const key = document.getElementById('newMainKey').value;
        const value = document.getElementById('newMainValue').value;

        fetch('/settings/dropdowns/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ group: 'ExpenseMainCategory', key: key, value: value })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message);
            }
        });
    });

    // View Sub Categories
    document.querySelectorAll('.view-sub-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const categoryKey = this.dataset.category;
            const section = document.getElementById('sub-category-' + categoryKey);

            // Toggle the expanded class
            section.classList.toggle('expanded');
        });
    });

    // Add Sub Category
    document.querySelectorAll('.add-sub-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentCategory = this.dataset.category;
            document.getElementById('subCategoryParent').value = currentCategory;
            document.getElementById('newSubKey').value = '';
            document.getElementById('newSubValue').value = '';
            new bootstrap.Modal(document.getElementById('addSubCategoryModal')).show();
        });
    });

    document.getElementById('saveSubCategoryBtn').addEventListener('click', function() {
        let subKey = document.getElementById('newSubKey').value.trim();

        // Remove the category prefix if the user accidentally included it
        if (subKey.startsWith(currentCategory + '_')) {
            subKey = subKey.substring((currentCategory + '_').length);
        }

        const key = currentCategory + '_' + subKey;
        const value = document.getElementById('newSubValue').value;

        fetch('/settings/dropdowns/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ group: 'ExpenseSubCategory', key: key, value: value })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal and reload page
                const modal = bootstrap.Modal.getInstance(document.getElementById('addSubCategoryModal'));
                if (modal) modal.hide();
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the sub-category.');
        });
    });

    // Edit Main Category
    document.querySelectorAll('.edit-category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const row = this.closest('tr');
            const valueSpan = row.querySelector('.category-value');
            const input = row.querySelector('.edit-input');

            if (input.classList.contains('d-none')) {
                valueSpan.classList.add('d-none');
                input.classList.remove('d-none');
                input.focus();
                this.innerHTML = '<i class="bi bi-check"></i>';
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-success');
                currentSettingId = this.dataset.id;
            } else {
                const newValue = input.value;
                fetch(`/settings/dropdowns/${currentSettingId}/edit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ value: newValue })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        valueSpan.textContent = newValue;
                        valueSpan.classList.remove('d-none');
                        input.classList.add('d-none');
                        this.innerHTML = '<i class="bi bi-pencil"></i>';
                        this.classList.remove('btn-success');
                        this.classList.add('btn-outline-primary');
                    } else {
                        alert(data.message);
                    }
                });
            }
        });
    });

    // Delete Main Category
    document.querySelectorAll('.delete-category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this main category and all its sub-categories?')) {
                const settingId = this.dataset.id;
                fetch(`/settings/dropdowns/${settingId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                });
            }
        });
    });

    // Edit Sub Category
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const row = this.closest('tr');
            const valueSpan = row.querySelector('.setting-value');
            const input = row.querySelector('.edit-input');

            if (input.classList.contains('d-none')) {
                valueSpan.classList.add('d-none');
                input.classList.remove('d-none');
                input.focus();
                this.innerHTML = '<i class="bi bi-check"></i>';
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-success');
                currentSettingId = this.dataset.id;
            } else {
                const newValue = input.value;
                fetch(`/settings/dropdowns/${currentSettingId}/edit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ value: newValue })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        valueSpan.textContent = newValue;
                        valueSpan.classList.remove('d-none');
                        input.classList.add('d-none');
                        this.innerHTML = '<i class="bi bi-pencil"></i>';
                        this.classList.remove('btn-success');
                        this.classList.add('btn-outline-primary');
                    } else {
                        alert(data.message);
                    }
                });
            }
        });
    });

    // Delete Sub Category
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this sub-category?')) {
                const settingId = this.dataset.id;
                fetch(`/settings/dropdowns/${settingId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.closest('tr').remove();
                        // Update count badge
                        const categoryKey = this.closest('.sub-category-section').id.replace('sub-category-', '');
                        const badge = document.querySelector(`[data-category="${categoryKey}"]`).previousElementSibling;
                        const currentCount = parseInt(badge.textContent);
                        badge.textContent = currentCount - 1;
                    } else {
                        alert(data.message);
                    }
                });
            }
        });
    });
});
</script>
{% endblock %}